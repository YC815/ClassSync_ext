<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>測試 fillModalByPayload 函數</title>
    <style>
        body { font-family: Arial, sans-serif; padding: 20px; }
        .modal-box {
            border: 2px solid #ccc;
            padding: 20px;
            margin: 20px 0;
            width: 500px;
            height: 300px;
        }
        .p-4.space-y-4 {
            border: 1px solid #ddd;
            padding: 10px;
            margin: 10px 0;
        }
        .text-xl.text-primary { font-size: 1.2em; font-weight: bold; }
        select { margin: 5px 0; padding: 5px; }
        .test-result {
            margin: 10px 0;
            padding: 10px;
            border-radius: 5px;
        }
        .success { background-color: #d4edda; border: 1px solid #c3e6cb; }
        .error { background-color: #f8d7da; border: 1px solid #f5c6cb; }
        button {
            padding: 10px 20px;
            margin: 5px;
            border: none;
            border-radius: 3px;
            cursor: pointer;
        }
        .btn-primary { background-color: #007bff; color: white; }
        .btn-secondary { background-color: #6c757d; color: white; }
    </style>
</head>
<body>
    <h1>測試 fillModalByPayload 函數修復</h1>

    <div class="modal-box">
        <h3>模擬的 Modal 內容</h3>

        <div class="p-4 space-y-4">
            <p class="text-xl text-primary">2024-09-16 (週一)</p>
            <select name="slot1">
                <option value="">請選擇</option>
                <option value="classroom1">教室1</option>
                <option value="classroom2">教室2</option>
                <option value="library">圖書館</option>
                <option value="其他地點">其他地點</option>
            </select>
            <select name="slot2">
                <option value="">請選擇</option>
                <option value="classroom1">教室1</option>
                <option value="classroom2">教室2</option>
                <option value="library">圖書館</option>
                <option value="其他地點">其他地點</option>
            </select>
        </div>

        <div class="p-4 space-y-4">
            <p class="text-xl text-primary">2024-09-17 (週二)</p>
            <select name="slot1">
                <option value="">請選擇</option>
                <option value="classroom1">教室1</option>
                <option value="classroom2">教室2</option>
                <option value="library">圖書館</option>
                <option value="其他地點">其他地點</option>
            </select>
            <select name="slot2">
                <option value="">請選擇</option>
                <option value="classroom1">教室1</option>
                <option value="classroom2">教室2</option>
                <option value="library">圖書館</option>
                <option value="其他地點">其他地點</option>
            </select>
        </div>
    </div>

    <div>
        <h3>測試按鈕</h3>
        <button class="btn-primary" onclick="testNormalPayload()">測試正常 Payload</button>
        <button class="btn-primary" onclick="testCustomLocationPayload()">測試自定義地點 Payload</button>
        <button class="btn-primary" onclick="testInvalidPayload()">測試無效 Payload</button>
        <button class="btn-primary" onclick="testNullPayload()">測試 Null Payload</button>
        <button class="btn-secondary" onclick="hideModal()">隱藏 Modal</button>
        <button class="btn-secondary" onclick="showModal()">顯示 Modal</button>
        <button class="btn-secondary" onclick="clearResults()">清除結果</button>
    </div>

    <div id="testResults"></div>

    <script>
        // 修復後的自定義地點填寫相關函數

        // 比原本「寬高>0」更穩定：看 computedStyle 與禁用態
        function isInputReady(input) {
          if (!input) return false;
          const cs = getComputedStyle(input);
          const visible = cs.display !== 'none' && cs.visibility !== 'hidden' && cs.opacity !== '0';
          return visible && !input.disabled && !input.readOnly;
        }

        // 用原生 setter 寫值，解決 React/受控輸入不同步
        function setNativeInputValue(input, value) {
          const proto = Object.getPrototypeOf(input);
          const desc = Object.getOwnPropertyDescriptor(proto, 'value');
          const setter = desc && desc.set;
          if (setter) {
            setter.call(input, value);
          } else {
            // 理論上不會走到這，但保底
            input.value = value;
          }
          // 對受控元件，input 事件是關鍵
          input.dispatchEvent(new Event('input', { bubbles: true, cancelable: true }));
          input.dispatchEvent(new Event('change', { bubbles: true, cancelable: true }));
        }

        // 等待/取得該 slot 的自訂輸入框：優先用 MutationObserver，退而求其次輪詢
        function getOrWaitCustomInput(container, select, maxWaitMs = 3000) {
          return new Promise((resolve) => {
            // 先查一次
            const q = () => container?.querySelector('input[type="text"], input[placeholder*="地點"], input[placeholder*="名稱"], input.input');
            let found = q();
            if (found) return resolve(found);

            // 確保 select 已是「其他地點」
            if (select && select.value !== '其他地點') {
              select.value = '其他地點';
              select.dispatchEvent(new Event('change', { bubbles: true, cancelable: true }));
              select.dispatchEvent(new Event('input', { bubbles: true, cancelable: true }));
            }

            // 用 MutationObserver 等待輸入框出現
            const obs = new MutationObserver(() => {
              const el = q();
              if (el) {
                obs.disconnect();
                resolve(el);
              }
            });
            if (container) {
              obs.observe(container, { childList: true, subtree: true });
            }

            // 兜底 timeout
            setTimeout(() => {
              obs.disconnect();
              resolve(q() || null);
            }, maxWaitMs);
          });
        }

        async function fillCustomLocation(container, customName, slotIndex) {
          console.log(`測試填寫自訂地點: 時段 ${slotIndex + 1}, 地點: "${customName}"`);
          try {
            const select = container?.querySelector('select');

            // 確保「其他地點」已選
            if (select && select.value !== '其他地點') {
              select.value = '其他地點';
              select.dispatchEvent(new Event('change', { bubbles: true, cancelable: true }));
              select.dispatchEvent(new Event('input', { bubbles: true, cancelable: true }));
            }

            // 取得或等待 input
            const input = await getOrWaitCustomInput(container, select, 3000);

            if (!input) {
              console.error(`時段 ${slotIndex + 1}: 找不到輸入框`);
              return { success: false, reason: 'no-input', customLocationValue: null };
            }

            // 有些站點會短暫設為 readonly/disabled，這裡強制解除一次
            input.disabled = false;
            input.readOnly = false;

            // 滾到可見（避免某些框架對不可見元素忽略事件）
            input.scrollIntoView?.({ block: 'center', inline: 'nearest' });

            // 就算 isInputReady 回 false，也先試著填 — 很多時候其實能寫
            input.focus();
            setNativeInputValue(input, customName);
            input.blur();

            // 驗證
            const ok = input.value === customName;
            console.log(`時段 ${slotIndex + 1}: 自訂地點填寫 ${ok ? '✅' : '❌'} "${customName}" -> "${input.value}"`);
            return { success: ok, reason: ok ? 'filled' : 'value-mismatch', customLocationValue: input.value };
          } catch (err) {
            console.error(`時段 ${slotIndex + 1}: 填寫時發生錯誤:`, err);
            return { success: false, reason: 'fill-error', customLocationValue: null, error: err?.message };
          }
        }

        // 修復後的 fillModalByPayload 函數
        function fillModalByPayload(payload) {
          try {
            console.log("[ClassSync Fill] 開始填寫 Modal，payload:", payload);

            // 檢查執行環境
            if (typeof document === 'undefined') {
              console.error("[ClassSync Fill] ❌ Document 物件不存在，執行環境異常");
              return {
                ok: false,
                reason: "no-document",
                details: "Document object not available",
                filledDays: 0,
                totalDays: payload?.days?.length || 0,
                errors: [{ err: "no-document", details: "Document object not available" }],
                successRate: 0
              };
            }

            // 檢查 payload 有效性
            if (!payload || !payload.days || !Array.isArray(payload.days)) {
              console.error("[ClassSync Fill] ❌ 無效的 payload 格式");
              return {
                ok: false,
                reason: "invalid-payload",
                details: "Invalid payload format",
                filledDays: 0,
                totalDays: 0,
                errors: [{ err: "invalid-payload", details: "Payload is null or missing days array" }],
                successRate: 0
              };
            }

            // 檢查 modal 容器
            const modal = document.querySelector(".modal-box") || document.querySelector('[role="dialog"], .modal');
            if (!modal) {
              console.error("[ClassSync Fill] ❌ 找不到 modal 容器");
              return {
                ok: false,
                reason: "no-modal",
                details: "Modal element not found",
                filledDays: 0,
                totalDays: payload.days.length,
                errors: [{ err: "no-modal", details: "Modal element not found" }],
                successRate: 0
              };
            }

            console.log("[ClassSync Fill] ✅ 找到 modal 容器");

            // 檢查 modal 是否可見
            if (modal.offsetWidth === 0 || modal.offsetHeight === 0) {
              console.error("[ClassSync Fill] ❌ Modal 不可見");
              return {
                ok: false,
                reason: "modal-not-visible",
                details: "Modal is not visible",
                filledDays: 0,
                totalDays: payload.days.length,
                errors: [{ err: "modal-not-visible", details: "Modal is not visible" }],
                successRate: 0
              };
            }

            const result = {
              ok: true,
              filledDays: 0,
              totalDays: payload.days.length,
              errors: [],
              details: []
            };

            // 每天一個 block：<div class="p-4 space-y-4">
            const blocks = Array.from(modal.querySelectorAll(".p-4.space-y-4"));
            console.log(`[ClassSync Fill] 找到 ${blocks.length} 個日期區塊`);

            if (!blocks.length) {
              console.error("[ClassSync Fill] ❌ 找不到日期區塊");
              return {
                ok: false,
                reason: "no-day-blocks",
                details: "No day blocks found in modal",
                filledDays: 0,
                totalDays: payload.days.length,
                errors: [{ err: "no-day-blocks", details: "No day blocks found in modal" }],
                successRate: 0
              };
            }

            // 建立日期對應表
            const blockByDate = new Map();
            blocks.forEach((block, index) => {
              const title = block.querySelector("p.text-xl.text-primary");
              const txt = (title?.textContent || "").trim();
              const dateStr = txt.slice(0, 10);
              blockByDate.set(dateStr, block);
              console.log(`[ClassSync Fill] 區塊 ${index + 1}: ${txt} -> ${dateStr}`);
            });

            // 逐日填寫
            for (const d of payload.days) {
              console.log(`[ClassSync Fill] 處理日期: ${d.dateISO}, 地點: [${d.slots.join(', ')}]`);

              const block = blockByDate.get(d.dateISO);
              if (!block) {
                const error = { date: d.dateISO, err: "block-not-found" };
                result.errors.push(error);
                console.error(`[ClassSync Fill] ❌ 找不到日期區塊: ${d.dateISO}`);
                continue;
              }

              const selects = Array.from(block.querySelectorAll("select"));
              console.log(`[ClassSync Fill] 日期 ${d.dateISO} 找到 ${selects.length} 個下拉選單`);

              if (!selects.length) {
                const error = { date: d.dateISO, err: "no-selects" };
                result.errors.push(error);
                console.error(`[ClassSync Fill] ❌ 日期 ${d.dateISO} 找不到下拉選單`);
                continue;
              }

              let dayFilled = true;
              const dayDetails = { date: d.dateISO, slots: [] };

              // 填寫每個時段
              for (let i = 0; i < Math.min(selects.length, d.slots.length); i++) {
                const sel = selects[i];
                const want = (d.slots[i] || "").trim();
                const opts = Array.from(sel.options || []);
                const selectContainer = sel.closest('.w-full') || sel.parentElement;

                console.log(`[ClassSync Fill] 時段 ${i + 1}: 嘗試選擇 "${want}"`);
                console.log(`[ClassSync Fill] 可用選項: [${opts.map(o => o.textContent?.trim()).join(', ')}]`);

                // 檢查是否為「其他地點」的情況
                const isCustomLocation = want && !opts.some(o =>
                  ((o.value || "").trim() === want) ||
                  ((o.textContent || "").trim() === want)
                );

                if (isCustomLocation) {
                  console.log(`[ClassSync Fill] 時段 ${i + 1}: 檢測到自定義地點 "${want}"，使用自定義填寫邏輯`);

                  try {
                    const customResult = await fillCustomLocation(selectContainer, want, i);

                    dayDetails.slots.push({
                      index: i,
                      wanted: want,
                      selected: customResult.customLocationValue || want,
                      value: "其他地點",
                      success: customResult.success,
                      isCustomLocation: true
                    });

                    if (!customResult.success) {
                      dayFilled = false;
                      result.errors.push({
                        date: d.dateISO,
                        idx: i,
                        err: "custom-location-failed",
                        wanted: want,
                        customResult: customResult
                      });
                    }

                    continue;
                  } catch (error) {
                    console.error(`[ClassSync Fill] ❌ 時段 ${i + 1}: 自定義地點填寫錯誤:`, error);
                    dayFilled = false;
                    result.errors.push({
                      date: d.dateISO,
                      idx: i,
                      err: "custom-location-error",
                      wanted: want,
                      error: error.message
                    });

                    dayDetails.slots.push({
                      index: i,
                      wanted: want,
                      selected: null,
                      value: null,
                      success: false,
                      isCustomLocation: true
                    });
                    continue;
                  }
                }

                // 尋找匹配的選項（非自定義地點）
                let target = opts.find(o =>
                  ((o.value || "").trim() === want) ||
                  ((o.textContent || "").trim() === want)
                );

                if (!target) {
                  // 嘗試模糊匹配
                  target = opts.find(o => {
                    const optText = (o.textContent || "").trim();
                    return optText.includes(want) || want.includes(optText);
                  });
                }

                if (!target) {
                  // 使用第一個有效選項
                  target = opts.find(o =>
                    !o.disabled &&
                    o.value &&
                    o.value !== "none" &&
                    o.value !== "" &&
                    (o.textContent || "").trim() !== ""
                  );
                }

                if (target) {
                  sel.value = target.value;
                  sel.dispatchEvent(new Event("change", { bubbles: true }));

                  // 驗證是否設定成功
                  const afterValue = sel.value;
                  const success = afterValue === target.value;

                  console.log(`[ClassSync Fill] 時段 ${i + 1}: ${success ? '✅' : '❌'} ${want} -> ${target.textContent?.trim()} (value: ${target.value})`);

                  dayDetails.slots.push({
                    index: i,
                    wanted: want,
                    selected: target.textContent?.trim(),
                    value: target.value,
                    success: success
                  });

                  if (!success) {
                    dayFilled = false;
                    result.errors.push({
                      date: d.dateISO,
                      idx: i,
                      err: "set-value-failed",
                      wanted: want,
                      attempted: target.value
                    });
                  }
                } else {
                  console.error(`[ClassSync Fill] ❌ 時段 ${i + 1}: 找不到適合的選項給 "${want}"`);
                  dayFilled = false;
                  result.errors.push({
                    date: d.dateISO,
                    idx: i,
                    err: "option-not-found",
                    wanted: want,
                    availableOptions: opts.map(o => o.textContent?.trim()).filter(Boolean)
                  });

                  dayDetails.slots.push({
                    index: i,
                    wanted: want,
                    selected: null,
                    value: null,
                    success: false
                  });
                }
              }

              result.details.push(dayDetails);
              if (dayFilled) {
                result.filledDays += 1;
              }
            }

            // 計算成功率
            result.successRate = result.filledDays / result.totalDays;
            result.ok = result.errors.length === 0;

            console.log(`[ClassSync Fill] 填寫完成: ${result.filledDays}/${result.totalDays} 天成功, ${result.errors.length} 個錯誤`);

            return result;

          } catch (error) {
            console.error("[ClassSync Fill] ❌ 函數執行時發生未預期錯誤:", error);

            // 確保總是返回一個有效的結果對象
            return {
              ok: false,
              reason: "unexpected-error",
              details: error.message || "Unknown error occurred",
              filledDays: 0,
              totalDays: payload?.days?.length || 0,
              errors: [{
                err: "unexpected-error",
                details: error.message || "Unknown error occurred",
                stack: error.stack
              }],
              successRate: 0
            };
          }
        }

        function addTestResult(testName, result, success) {
            const resultsDiv = document.getElementById('testResults');
            const resultDiv = document.createElement('div');
            resultDiv.className = `test-result ${success ? 'success' : 'error'}`;
            resultDiv.innerHTML = `
                <h4>${testName}</h4>
                <pre>${JSON.stringify(result, null, 2)}</pre>
            `;
            resultsDiv.appendChild(resultDiv);
        }

        function testNormalPayload() {
            const payload = {
                days: [
                    {
                        dateISO: "2024-09-16",
                        slots: ["教室1", "圖書館"]
                    },
                    {
                        dateISO: "2024-09-17",
                        slots: ["教室2", "教室1"]
                    }
                ]
            };

            const result = fillModalByPayload(payload);
            addTestResult('正常 Payload 測試', result, result.ok && typeof result.successRate === 'number');
        }

        function testCustomLocationPayload() {
            const payload = {
                days: [
                    {
                        dateISO: "2024-09-16",
                        slots: ["實習公司", "圖書館"]
                    },
                    {
                        dateISO: "2024-09-17",
                        slots: ["咖啡廳", "家裡"]
                    }
                ]
            };

            const result = fillModalByPayload(payload);
            addTestResult('自定義地點 Payload 測試', result, result.ok && typeof result.successRate === 'number');
        }

        function testInvalidPayload() {
            const payload = {
                notDays: []
            };

            const result = fillModalByPayload(payload);
            addTestResult('無效 Payload 測試', result, !result.ok && result.reason === 'invalid-payload');
        }

        function testNullPayload() {
            const result = fillModalByPayload(null);
            addTestResult('Null Payload 測試', result, !result.ok && result.reason === 'invalid-payload');
        }

        function hideModal() {
            const modal = document.querySelector('.modal-box');
            modal.style.display = 'none';
        }

        function showModal() {
            const modal = document.querySelector('.modal-box');
            modal.style.display = 'block';
        }

        function clearResults() {
            document.getElementById('testResults').innerHTML = '';
        }
    </script>
</body>
</html>