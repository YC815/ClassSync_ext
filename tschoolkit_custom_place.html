<body
  inject_newsvd="true"
  monica-id="ofpnmcalabcbjgholdjcjblkibolbppb"
  monica-version="7.9.7"
>
  <div id="root">
    <div class="max-w-lg p-4 mx-auto space-y-4">
      <div class="rounded-lg bg-base-100">
        <div class="flex justify-center p-4">
          <div class="tabs tabs-boxed">
            <a class="tab">過去一週</a><a class="tab">已填本週</a
            ><a class="tab tab-active">待填下週</a>
          </div>
        </div>
        <div class="flex flex-col items-center justify-center gap-4 p-4">
          <button class="btn btn-sm btn-neutral">
            <svg
              stroke="currentColor"
              fill="currentColor"
              stroke-width="0"
              viewBox="0 0 512 512"
              class="w-5 h-5"
              height="1em"
              width="1em"
              xmlns="http://www.w3.org/2000/svg"
            >
              <path
                fill="none"
                stroke-linecap="round"
                stroke-linejoin="round"
                stroke-width="32"
                d="M384 224v184a40 40 0 0 1-40 40H104a40 40 0 0 1-40-40V168a40 40 0 0 1 40-40h167.48"
              ></path>
              <path
                d="M459.94 53.25a16.06 16.06 0 0 0-23.22-.56L424.35 65a8 8 0 0 0 0 11.31l11.34 11.32a8 8 0 0 0 11.34 0l12.06-12c6.1-6.09 6.67-16.01.85-22.38zM399.34 90 218.82 270.2a9 9 0 0 0-2.31 3.93L208.16 299a3.91 3.91 0 0 0 4.86 4.86l24.85-8.35a9 9 0 0 0 3.93-2.31L422 112.66a9 9 0 0 0 0-12.66l-9.95-10a9 9 0 0 0-12.71 0z"
              ></path></svg
            ><span class="font-normal normal-case">週曆填報</span>
          </button>
          <div
            id="next-week-event-modal"
            class="modal modal-bottom sm:modal-middle modal-open"
          >
            <div class="modal-box sm:max-w-sm bg-base-200">
              <div class="mt-4 divide-y rounded-lg bg-base-100">
                <div class="p-4 space-y-4">
                  <p class="text-xl text-primary">2025-09-22 (一)</p>
                  <div class="grid grid-cols-2 gap-4">
                    <div class="w-full">
                      <select
                        class="w-full py-0 text-base font-normal select select-sm select-bordered"
                      >
                        <option disabled="" value="none">選取地點</option>
                        <option value="弘道基地">弘道基地</option>
                        <option value="吉林基地">吉林基地</option>
                        <option value="在家中">在家中</option>
                        <option value="其他地點">其他地點</option>
                      </select>
                    </div>
                    <div class="w-full">
                      <select
                        class="w-full py-0 text-base font-normal select select-sm select-bordered"
                      >
                        <option disabled="" value="none">選取地點</option>
                        <option value="弘道基地">弘道基地</option>
                        <option value="吉林基地">吉林基地</option>
                        <option value="在家中">在家中</option>
                        <option value="其他地點">其他地點</option>
                      </select>
                    </div>
                  </div>
                </div>
                <div class="p-4 space-y-4">
                  <p class="text-xl text-primary">2025-09-23 (二)</p>
                  <div class="grid grid-cols-2 gap-4">
                    <div class="w-full">
                      <select
                        class="w-full py-0 text-base font-normal select select-sm select-bordered"
                      >
                        <option disabled="" value="none">選取地點</option>
                        <option value="弘道基地">弘道基地</option>
                        <option value="吉林基地">吉林基地</option>
                        <option value="在家中">在家中</option>
                        <option value="其他地點">其他地點</option>
                      </select>
                    </div>
                    <div class="w-full">
                      <select
                        class="w-full py-0 text-base font-normal select select-sm select-bordered"
                      >
                        <option disabled="" value="none">選取地點</option>
                        <option value="弘道基地">弘道基地</option>
                        <option value="吉林基地">吉林基地</option>
                        <option value="在家中">在家中</option>
                        <option value="其他地點">其他地點</option>
                      </select>
                    </div>
                  </div>
                </div>
                <div class="p-4 space-y-4">
                  <p class="text-xl text-primary">2025-09-24 (三)</p>
                  <div class="grid grid-cols-2 gap-4">
                    <div class="w-full">
                      <select
                        class="w-full py-0 text-base font-normal select select-sm select-bordered"
                      >
                        <option disabled="" value="none">選取地點</option>
                        <option value="弘道基地">弘道基地</option>
                        <option value="吉林基地">吉林基地</option>
                        <option value="在家中">在家中</option>
                        <option value="其他地點">其他地點</option>
                      </select>
                    </div>
                    <div class="w-full">
                      <select
                        class="w-full py-0 text-base font-normal select select-sm select-bordered"
                      >
                        <option disabled="" value="none">選取地點</option>
                        <option value="弘道基地">弘道基地</option>
                        <option value="吉林基地">吉林基地</option>
                        <option value="在家中">在家中</option>
                        <option value="其他地點">其他地點</option></select
                      ><input
                        type="text"
                        class="w-full mt-2 text-base font-normal input input-sm input-bordered"
                        placeholder="請填寫地點名稱"
                        value=""
                      />
                    </div>
                  </div>
                </div>
                <div class="p-4 space-y-4">
                  <p class="text-xl text-primary">2025-09-25 (四)</p>
                  <div class="grid grid-cols-2 gap-4">
                    <div class="w-full">
                      <select
                        class="w-full py-0 text-base font-normal select select-sm select-bordered"
                      >
                        <option disabled="" value="none">選取地點</option>
                        <option value="弘道基地">弘道基地</option>
                        <option value="吉林基地">吉林基地</option>
                        <option value="在家中">在家中</option>
                        <option value="其他地點">其他地點</option>
                      </select>
                    </div>
                    <div class="w-full">
                      <select
                        class="w-full py-0 text-base font-normal select select-sm select-bordered"
                      >
                        <option disabled="" value="none">選取地點</option>
                        <option value="弘道基地">弘道基地</option>
                        <option value="吉林基地">吉林基地</option>
                        <option value="在家中">在家中</option>
                        <option value="其他地點">其他地點</option>
                      </select>
                    </div>
                  </div>
                </div>
                <div class="p-4 space-y-4">
                  <p class="text-xl text-primary">2025-09-26 (五)</p>
                  <div class="grid grid-cols-2 gap-4">
                    <div class="w-full">
                      <select
                        class="w-full py-0 text-base font-normal select select-sm select-bordered"
                      >
                        <option disabled="" value="none">選取地點</option>
                        <option value="弘道基地">弘道基地</option>
                        <option value="吉林基地">吉林基地</option>
                        <option value="在家中">在家中</option>
                        <option value="其他地點">其他地點</option></select
                      ><input
                        type="text"
                        class="w-full mt-2 text-base font-normal input input-sm input-bordered"
                        placeholder="請填寫地點名稱"
                        value=""
                      />
                    </div>
                    <div class="w-full">
                      <select
                        class="w-full py-0 text-base font-normal select select-sm select-bordered"
                      >
                        <option disabled="" value="none">選取地點</option>
                        <option value="弘道基地">弘道基地</option>
                        <option value="吉林基地">吉林基地</option>
                        <option value="在家中">在家中</option>
                        <option value="其他地點">其他地點</option>
                      </select>
                    </div>
                  </div>
                </div>
              </div>
              <div class="justify-between modal-action">
                <button class="btn btn-square btn-neutral">
                  <svg
                    stroke="currentColor"
                    fill="currentColor"
                    stroke-width="0"
                    viewBox="0 0 512 512"
                    class="w-5 h-5"
                    height="1em"
                    width="1em"
                    xmlns="http://www.w3.org/2000/svg"
                  >
                    <path
                      fill="none"
                      stroke-linecap="round"
                      stroke-linejoin="round"
                      stroke-width="32"
                      d="M368 368 144 144m224 0L144 368"
                    ></path>
                  </svg></button
                ><button class="btn btn-neutral">
                  <svg
                    stroke="currentColor"
                    fill="currentColor"
                    stroke-width="0"
                    viewBox="0 0 512 512"
                    class="w-5 h-5"
                    height="1em"
                    width="1em"
                    xmlns="http://www.w3.org/2000/svg"
                  >
                    <path
                      fill="none"
                      stroke-linecap="round"
                      stroke-linejoin="round"
                      stroke-width="32"
                      d="M470.3 271.15 43.16 447.31a7.83 7.83 0 0 1-11.16-7V327a8 8 0 0 1 6.51-7.86l247.62-47c17.36-3.29 17.36-28.15 0-31.44l-247.63-47a8 8 0 0 1-6.5-7.85V72.59c0-5.74 5.88-10.26 11.16-8L470.3 241.76a16 16 0 0 1 0 29.39z"
                    ></path></svg
                  ><span class="font-normal normal-case">回報計劃</span>
                </button>
              </div>
            </div>
          </div>
          <p class="text-lg">填寫時間：2025-09-15 17:42:13</p>
          <div class="p-4 space-y-2 rounded-lg bg-base-200/80">
            <p class="text-base">開始時間：2025-09-15 00:00:00</p>
            <p class="text-base">截止時間：2025-09-18 16:59:59</p>
          </div>
        </div>
        <div class="divide-y">
          <div>
            <div class="flex items-center gap-4 p-2">
              <div class="px-3 py-2 w-fit">
                <p class="text-xl text-primary">2025-09-22 (一)</p>
              </div>
            </div>
            <div class="grid grid-cols-2 gap-4 p-4">
              <div class="flex flex-col items-center gap-2">
                <p class="px-2 py-1 rounded-lg bg-base-200 whitespace-nowrap">
                  應該到校
                </p>
                <div><p class="text-lg text-center">弘道基地</p></div>
              </div>
              <div class="flex flex-col items-center gap-2">
                <p class="px-2 py-1 rounded-lg bg-base-200 whitespace-nowrap">
                  應該到校
                </p>
                <div><p class="text-lg text-center">弘道基地</p></div>
              </div>
            </div>
          </div>
          <div>
            <div class="flex items-center gap-4 p-2">
              <div class="px-3 py-2 w-fit">
                <p class="text-xl text-primary">2025-09-23 (二)</p>
              </div>
            </div>
            <div class="grid grid-cols-2 gap-4 p-4">
              <div class="flex flex-col items-center gap-2">
                <p class="px-2 py-1 rounded-lg bg-base-200 whitespace-nowrap">
                  應該到校
                </p>
                <div><p class="text-lg text-center">弘道基地</p></div>
              </div>
              <div class="flex flex-col items-center gap-2">
                <p class="px-2 py-1 rounded-lg bg-base-200 whitespace-nowrap">
                  應該到校
                </p>
                <div><p class="text-lg text-center">弘道基地</p></div>
              </div>
            </div>
          </div>
          <div>
            <div class="flex items-center gap-4 p-2">
              <div class="px-3 py-2 w-fit">
                <p class="text-xl text-primary">2025-09-24 (三)</p>
              </div>
            </div>
            <div class="grid grid-cols-2 gap-4 p-4">
              <div class="flex flex-col items-center gap-2">
                <p class="px-2 py-1 rounded-lg bg-base-200 whitespace-nowrap">
                  應該到校
                </p>
                <div><p class="text-lg text-center">吉林基地</p></div>
              </div>
              <div class="flex flex-col items-center gap-2">
                <p class="px-2 py-1 rounded-lg bg-base-200 whitespace-nowrap">
                  應該到校
                </p>
                <div><p class="text-lg text-center">吉林基地</p></div>
              </div>
            </div>
          </div>
          <div>
            <div class="flex items-center gap-4 p-2">
              <div class="px-3 py-2 w-fit">
                <p class="text-xl text-primary">2025-09-25 (四)</p>
              </div>
            </div>
            <div class="grid grid-cols-2 gap-4 p-4">
              <div class="flex flex-col items-center gap-2">
                <p class="px-2 py-1 rounded-lg bg-base-200 whitespace-nowrap">
                  應該到校
                </p>
                <div><p class="text-lg text-center">弘道基地</p></div>
              </div>
              <div class="flex flex-col items-center gap-2">
                <p class="px-2 py-1 rounded-lg bg-base-200 whitespace-nowrap">
                  應該到校
                </p>
                <div><p class="text-lg text-center">弘道基地</p></div>
              </div>
            </div>
          </div>
          <div>
            <div class="flex items-center gap-4 p-2">
              <div class="px-3 py-2 w-fit">
                <p class="text-xl text-primary">2025-09-26 (五)</p>
              </div>
            </div>
            <div class="grid grid-cols-2 gap-4 p-4">
              <div class="flex flex-col items-center gap-2">
                <p class="px-2 py-1 rounded-lg bg-base-200 whitespace-nowrap">
                  應該到校
                </p>
                <div><p class="text-lg text-center">吉林基地</p></div>
              </div>
              <div class="flex flex-col items-center gap-2">
                <p class="px-2 py-1 rounded-lg bg-base-200 whitespace-nowrap">
                  應該到校
                </p>
                <div><p class="text-lg text-center">吉林基地</p></div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <div id="newsvd_popupMenu" style="display: none"></div>
  <div id="newsvd_popupMenu"></div>
  <div id="newsvdPrice" class="newsvd_mengceng" style="display: none"></div>
  <div
    id="monica-content-root"
    class="monica-widget"
    style="pointer-events: auto"
  ></div>

  <!-- 測試控制面板 -->
  <div style="position: fixed; top: 10px; right: 10px; background: white; border: 2px solid #ccc; padding: 20px; z-index: 9999; border-radius: 8px; box-shadow: 0 4px 8px rgba(0,0,0,0.1);">
    <h3>自訂地點測試控制台</h3>
    <div style="margin: 10px 0;">
      <button onclick="testCustomLocation('實習公司')" style="padding: 8px 16px; margin: 4px; background: #007bff; color: white; border: none; border-radius: 4px; cursor: pointer;">
        測試填寫「實習公司」
      </button>
    </div>
    <div style="margin: 10px 0;">
      <button onclick="testCustomLocation('圖書館')" style="padding: 8px 16px; margin: 4px; background: #28a745; color: white; border: none; border-radius: 4px; cursor: pointer;">
        測試填寫「圖書館」
      </button>
    </div>
    <div style="margin: 10px 0;">
      <button onclick="clearTestResults()" style="padding: 8px 16px; margin: 4px; background: #6c757d; color: white; border: none; border-radius: 4px; cursor: pointer;">
        清除結果
      </button>
    </div>
    <div id="test-results" style="margin-top: 20px; max-height: 300px; overflow-y: auto; font-family: monospace; font-size: 12px;"></div>
  </div>

  <script>
    // 更穩健的可編輯判斷
    function isEditable(el) {
      if (!el) return false;
      const cs = window.getComputedStyle(el);
      const visible = cs.display !== 'none' && cs.visibility !== 'hidden' && el.getClientRects().length > 0;
      const enabled = !el.disabled && !el.readOnly && !el.hasAttribute('aria-disabled');
      return visible && enabled;
    }

    // 以 MutationObserver + 兩次 rAF 等待「真的可編輯」
    function waitUntilEditable(targetEl, { timeout = 3000 } = {}) {
      return new Promise((resolve) => {
        if (isEditable(targetEl)) return resolve(true);

        let done = false;
        const stop = () => { if (!done) { done = true; obs.disconnect(); clearTimeout(tid); } };

        const obs = new MutationObserver(async () => {
          // 多等兩個 animation frame，確保 layout 與樣式完成
          await new Promise(r => requestAnimationFrame(() => requestAnimationFrame(r)));
          if (isEditable(targetEl)) { stop(); resolve(true); }
        });

        obs.observe(document.documentElement, { attributes: true, childList: true, subtree: true });

        const tid = setTimeout(() => { stop(); resolve(false); }, timeout);
      });
    }

    // 精簡且穩健的自訂地點填寫函數
    async function fillCustomLocation(container, customName) {
      const select = container?.querySelector('select');
      if (!select) {
        return { success: false, reason: 'no-select' };
      }

      // 1) 確保顯示自訂輸入框
      if (select.value !== '其他地點') {
        select.value = '其他地點';
        select.dispatchEvent(new Event('input', { bubbles: true, composed: true }));
        select.dispatchEvent(new Event('change', { bubbles: true, composed: true }));
      }

      // 2) 更精準地抓目標 input（避免抓到不相關的 text input）
      const input = container.querySelector('input.input.input-sm.input-bordered[placeholder="請填寫地點名稱"]')
                 || container.querySelector('input[type="text"]');

      if (!input) {
        return { success: false, reason: 'no-input-found' };
      }

      // 3) 等到真的可編輯
      const ok = await waitUntilEditable(input, { timeout: 3000 });
      if (!ok) {
        return {
          success: false,
          reason: 'timeout-after-ready-check',
          debugInfo: {
            rects: input.getClientRects().length,
            display: getComputedStyle(input).display,
            visibility: getComputedStyle(input).visibility,
            disabled: input.disabled,
            readOnly: input.readOnly
          }
        };
      }

      // 4) 用更貼近真人的輸入流程，觸發站方可能綁定的 key/input 監聽
      try {
        input.focus();
        input.value = '';
        input.dispatchEvent(new Event('focus', { bubbles: true }));
        for (const ch of customName) {
          input.dispatchEvent(new KeyboardEvent('keydown', { key: ch, bubbles: true }));
          input.setRangeText(ch, input.selectionStart ?? input.value.length, input.selectionEnd ?? input.value.length, 'end');
          input.dispatchEvent(new Event('input', { bubbles: true }));
          input.dispatchEvent(new KeyboardEvent('keyup', { key: ch, bubbles: true }));
        }
        input.dispatchEvent(new Event('change', { bubbles: true }));
        input.blur();

        const success = input.value === customName;
        return { success, reason: success ? 'filled' : 'value-mismatch', customLocationValue: input.value };
      } catch (e) {
        return { success: false, reason: 'fill-error', error: e?.message };
      }
    }

    function logTestResult(message, data) {
      const resultsDiv = document.getElementById('test-results');
      const timestamp = new Date().toLocaleTimeString();
      const logEntry = document.createElement('div');
      logEntry.style.marginBottom = '8px';
      logEntry.style.padding = '4px';
      logEntry.style.borderLeft = data?.success ? '4px solid #28a745' : '4px solid #dc3545';
      logEntry.style.backgroundColor = data?.success ? '#d4edda' : '#f8d7da';
      logEntry.innerHTML = `
        <div style="font-weight: bold;">[${timestamp}] ${message}</div>
        ${data ? `<pre style="margin: 4px 0; font-size: 11px;">${JSON.stringify(data, null, 2)}</pre>` : ''}
      `;
      resultsDiv.appendChild(logEntry);
      resultsDiv.scrollTop = resultsDiv.scrollHeight;
    }

    async function testCustomLocation(customName) {
      logTestResult(`開始測試自訂地點: "${customName}"`);

      // 找到第一個有「其他地點」選項但還沒有輸入框的容器
      const containers = Array.from(document.querySelectorAll('.w-full'));
      let targetContainer = null;

      for (const container of containers) {
        const select = container.querySelector('select');
        const hasOtherOption = select && Array.from(select.options).some(opt => opt.value === '其他地點');
        const hasInput = container.querySelector('input[type="text"]');

        if (hasOtherOption && !hasInput) {
          targetContainer = container;
          break;
        }
      }

      if (!targetContainer) {
        logTestResult('測試失敗：找不到合適的測試容器', { success: false, reason: 'no-suitable-container' });
        return;
      }

      logTestResult(`找到測試容器，開始填寫...`);

      try {
        const result = await fillCustomLocation(targetContainer, customName);
        logTestResult(`測試完成`, result);
      } catch (error) {
        logTestResult('測試發生錯誤', { success: false, error: error.message });
      }
    }

    function clearTestResults() {
      document.getElementById('test-results').innerHTML = '';
    }

    // 監聽 modal 容器內的下拉選單變化，自動移除不需要的輸入框
    // 限制監聽範圍到 modal 容器，避免影響頁面其他部分
    const modalContainer = document.querySelector('.modal-box') || document.querySelector('#next-week-event-modal');
    if (modalContainer) {
      modalContainer.addEventListener('change', function(event) {
        if (event.target.tagName === 'SELECT') {
          const container = event.target.closest('.w-full');
          if (container && modalContainer.contains(container)) {
            const input = container.querySelector('input[type="text"]');
            if (input && event.target.value !== '其他地點') {
              input.remove();
              console.log('已移除不需要的自訂地點輸入框');
            }
          }
        }
      });
      console.log('事件監聽器已綁定到 modal 容器，避免影響其他區域');
    } else {
      console.warn('找不到 modal 容器，將使用全域監聽器');
      // 作為備用方案，仍然使用全域監聽器，但增加更嚴格的檢查
      document.addEventListener('change', function(event) {
        if (event.target.tagName === 'SELECT') {
          const container = event.target.closest('.w-full');
          // 只處理在 modal 內的容器
          if (container && (container.closest('.modal-box') || container.closest('#next-week-event-modal'))) {
            const input = container.querySelector('input[type="text"]');
            if (input && event.target.value !== '其他地點') {
              input.remove();
              console.log('已移除不需要的自訂地點輸入框');
            }
          }
        }
      });
    }

    console.log('自訂地點測試腳本已載入');
  </script>
</body>
