# ClassSync Tschool API

æä¾›é€±æ›†è³‡æ–™çš„ Next.js APIï¼Œä¾› ClassSync æ“´å……åŠŸèƒ½ä½¿ç”¨ã€‚

## ğŸ“‹ åŠŸèƒ½ç‰¹è‰²

- ğŸ” Bearer Token é©—è­‰æ©Ÿåˆ¶
- ğŸ“… **è‡ªå‹•è¨ˆç®—å°ç£å­¸åˆ¶æ°‘åœ‹å­¸å¹´åº¦å­¸æœŸ (YYY-N æ ¼å¼)**
- ğŸ—“ï¸ **ç²¾ç¢ºçš„å­¸æœŸé€±æ¬¡è¨ˆç®—ï¼ˆç¬¬ä¸€å­¸æœŸ8-1æœˆï¼Œç¬¬äºŒå­¸æœŸ2-7æœˆï¼‰**
- ğŸ« æ”¯æ´å¤šç¨®åœ°é»é¸é …ï¼ˆå¼˜é“åŸºåœ°ã€å‰æ—åŸºåœ°ã€åœ¨å®¶ä¸­ã€è‡ªè¨‚åœ°é»ï¼‰
- âœ¨ å®Œæ•´çš„å‹åˆ¥é©—è­‰ (Zod)
- ğŸ”„ CORS æ”¯æ´
- ğŸ“ è©³ç´°çš„éŒ¯èª¤è™•ç†å’Œæ—¥èªŒ
- ğŸ§ª **å®Œæ•´çš„å–®å…ƒæ¸¬è©¦è¦†è“‹**

## ğŸš€ å¿«é€Ÿé–‹å§‹

### 1. å®‰è£ä¾è³´

```bash
npm install
```

### 2. è¨­å®šç’°å¢ƒè®Šæ•¸

è¤‡è£½ `.env.example` ç‚º `.env.local`ï¼š

```bash
cp .env.example .env.local
```

ç·¨è¼¯ `.env.local`ï¼š

```bash
# ç”Ÿæˆä¸€å€‹å¼·å¯†é‘°
openssl rand -base64 32

# å¡«å…¥ .env.local
TSCHOOL_API_SECRET="ä½ çš„å¯†é‘°"
NODE_ENV="production"
```

### 3. é–‹ç™¼æ¨¡å¼

```bash
npm run dev
```

### 4. éƒ¨ç½²åˆ° Zeabur

```bash
# å»ºç½®
npm run build

# éƒ¨ç½²åˆ° Zeabur
# è«‹åƒè€ƒ Zeabur å®˜æ–¹æ–‡æª”
```

## ğŸ“¡ API æ–‡æª”

### å–å¾—é€±æ›† Payload

**ç«¯é»**: `GET /api/tschool/payload`

**æ¨™é ­**:
```
Authorization: Bearer YOUR_API_SECRET
Content-Type: application/json
```

**æŸ¥è©¢åƒæ•¸**:
- `week` (å¯é¸): é€±æ¬¡ï¼Œé è¨­ç‚ºç•¶å‰è¨ˆç®—é€±æ¬¡
- `weekStartISO` (å¯é¸): é€±ä¸€æ—¥æœŸ (YYYY-MM-DD)ï¼Œé è¨­ç‚ºä¸‹é€±ä¸€
- `userEmail` (å¯é¸): ä½¿ç”¨è€… email

**ç¯„ä¾‹è«‹æ±‚**:
```bash
curl -H "Authorization: Bearer your-secret-key" \
     "https://cst.zeabur.app/api/tschool/payload?week=39&weekStartISO=2024-09-23&userEmail=test@tschool.tp.edu.tw"
```

**ç¯„ä¾‹å›æ‡‰**:
```json
{
  "id": "test@tschool.tp.edu.tw.39",
  "week": 39,
  "semester": "114-1",
  "uid": "uid-test-tschool-tp-edu-tw",
  "name": "test",
  "email": "test@tschool.tp.edu.tw",
  "deadline": "2024-09-30 16:59:59",
  "begin": "2024-09-23 00:00:00",
  "timestamp": 1726503234567,
  "logs": ["2024-09-16 20:27:14"],
  "2024-09-23": { "am": "å¼˜é“åŸºåœ°", "pm": "å¼˜é“åŸºåœ°" },
  "2024-09-24": { "am": "å¼˜é“åŸºåœ°", "pm": "å¼˜é“åŸºåœ°" },
  "2024-09-25": { "am": "å¼˜é“åŸºåœ°", "pm": "å¼˜é“åŸºåœ°" },
  "2024-09-26": { "am": "å¼˜é“åŸºåœ°", "pm": "å¼˜é“åŸºåœ°" },
  "2024-09-27": { "am": "å¼˜é“åŸºåœ°", "pm": "å¼˜é“åŸºåœ°" }
}
```

## ğŸ“ å­¸å¹´åº¦å­¸æœŸç³»çµ±

### å°ç£å­¸åˆ¶å­¸æœŸå®šç¾©

æœ¬ API æ”¯æ´å°ç£æ•™è‚²é«”ç³»çš„æ°‘åœ‹å­¸å¹´åº¦è¨ˆç®—ï¼š

#### å­¸æœŸå€é–“
- **ç¬¬ä¸€å­¸æœŸ**ï¼š8æœˆ1æ—¥ ï½ ç¿Œå¹´1æœˆ31æ—¥ (N = 1)
- **ç¬¬äºŒå­¸æœŸ**ï¼š2æœˆ1æ—¥ ï½ 7æœˆ31æ—¥ (N = 2)

#### å­¸å¹´åº¦è¨ˆç®—è¦å‰‡
- **8-12æœˆ**ï¼šç•¶å¹´åœ‹æ›†å¹´ - 1911 â†’ ç•¶å­¸å¹´åº¦ç¬¬ä¸€å­¸æœŸ
- **1æœˆ**ï¼šå‰ä¸€å¹´åœ‹æ›†å¹´ - 1911 â†’ å‰å­¸å¹´åº¦ç¬¬ä¸€å­¸æœŸ
- **2-7æœˆ**ï¼šå‰ä¸€å¹´åœ‹æ›†å¹´ - 1911 â†’ å‰å­¸å¹´åº¦ç¬¬äºŒå­¸æœŸ

#### ç¯„ä¾‹å°ç…§è¡¨
| æ—¥æœŸ | å­¸æœŸ | èªªæ˜ |
|------|------|------|
| 2025/01/20 | **113-1** | 113å­¸å¹´åº¦ç¬¬1å­¸æœŸ |
| 2025/02/15 | **113-2** | 113å­¸å¹´åº¦ç¬¬2å­¸æœŸ |
| 2025/09/10 | **114-1** | 114å­¸å¹´åº¦ç¬¬1å­¸æœŸ |
| 2026/03/05 | **114-2** | 114å­¸å¹´åº¦ç¬¬2å­¸æœŸ |

### è‡ªå‹•å­¸æœŸè¨ˆç®—

API æœƒæ ¹æ“šè«‹æ±‚æ™‚é–“è‡ªå‹•è¨ˆç®—æ­£ç¢ºçš„å­¸å¹´åº¦å­¸æœŸï¼š

```bash
# ä¸æŒ‡å®šå­¸æœŸï¼Œç³»çµ±è‡ªå‹•è¨ˆç®—
curl -H "Authorization: Bearer your-secret-key" \
     "https://cst.zeabur.app/api/tschool/payload"

# æ‰‹å‹•æŒ‡å®šé€±æ¬¡ï¼Œä½†å­¸æœŸä»æœƒå‹•æ…‹è¨ˆç®—
curl -H "Authorization: Bearer your-secret-key" \
     "https://cst.zeabur.app/api/tschool/payload?week=5&weekStartISO=2025-09-01"
```

## ğŸ¯ åœ°é»è¦å‰‡

### é è¨­åœ°é»
- `å¼˜é“åŸºåœ°`
- `å‰æ—åŸºåœ°`
- `åœ¨å®¶ä¸­`

### è‡ªè¨‚åœ°é»
æ ¼å¼ï¼š`å…¶ä»–åœ°é»:åœ°é»åç¨±`

ç¯„ä¾‹ï¼š
- `å…¶ä»–åœ°é»:åœ–æ›¸é¤¨`
- `å…¶ä»–åœ°é»:å¯¦é©—å®¤`
- `å…¶ä»–åœ°é»:æ ¡å¤–å¯¦ç¿’`

## âš™ï¸ è‡ªè¨‚è¨­å®š

åœ¨ `route.ts` çš„ `getUserInfo` å‡½æ•¸ä¸­ï¼Œä½ å¯ä»¥è¨­å®šæ¯ä½ä½¿ç”¨è€…çš„è‡ªè¨‚è¡Œç¨‹ï¼š

```typescript
// ç¯„ä¾‹ï¼šç‰¹å®šæ—¥æœŸçš„è‡ªè¨‚è¡Œç¨‹
customSchedule: {
  "2024-09-25": { am: "å…¶ä»–åœ°é»:åœ–æ›¸é¤¨", pm: "å‰æ—åŸºåœ°" },
  "2024-09-27": { am: "å¼˜é“åŸºåœ°", pm: "å…¶ä»–åœ°é»:å¯¦é©—å®¤" }
}
```

## ğŸ”— æ“´å……åŠŸèƒ½æ•´åˆ

### 1. æ›´æ–° manifest.json

```json
{
  "host_permissions": [
    "https://tschoolkit.web.app/*",
    "https://asia-east1-campus-lite.cloudfunctions.net/*",
    "https://cst.zeabur.app/*"
  ]
}
```

### 2. æ›´æ–° background.js

```javascript
const NEXT_API_PAYLOAD = 'https://cst.zeabur.app/api/tschool/payload';
const API_SECRET = 'your-secret-key'; // èˆ‡ .env.local ä¸€è‡´

// ä½¿ç”¨æ–°çš„ API æµç¨‹
async function submitCalendar(idToken, userData = {}) {
  // 1. å¾ Next.js API å–å¾— payload
  const payload = await fetchPayloadFromAPI(userData);

  // 2. çµåˆ idToken é€åˆ° setCalendar
  const response = await fetch(TSCHOOL_API, {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({
      idToken,
      data: payload,
      nextWeek: true
    })
  });
}
```

## ğŸ”§ é–‹ç™¼æŒ‡å—

### æ¶æ§‹è¨­è¨ˆ

```
/app/api/tschool/payload/
â”œâ”€â”€ route.ts              # ä¸»è¦ API ç«¯é»
â”œâ”€â”€ types.ts              # TypeScript å‹åˆ¥å®šç¾©
â”œâ”€â”€ semester-utils.ts     # å­¸æœŸè¨ˆç®—å·¥å…·å‡½æ•¸
â””â”€â”€ __tests__/           # å–®å…ƒæ¸¬è©¦
    â””â”€â”€ semester.test.ts # å­¸æœŸè¨ˆç®—æ¸¬è©¦
```

### å‹åˆ¥å®šç¾©

æ‰€æœ‰å‹åˆ¥å®šç¾©åœ¨ `app/api/tschool/payload/types.ts`ï¼š

- `TschoolPayload`: å®Œæ•´çš„é€±æ›†è³‡æ–™æ ¼å¼
- `UserInfo`: ä½¿ç”¨è€…è³‡è¨Š
- `PayloadRequest`: API è«‹æ±‚åƒæ•¸
- `Semester`: å­¸æœŸå­—ä¸²æ ¼å¼ "YYY-N"
- `AcademicYear`: å­¸æœŸè©³ç´°è³‡è¨Š

### å­¸æœŸå·¥å…·å‡½æ•¸

`app/api/tschool/payload/semester-utils.ts` æä¾›ï¼š

- `getSemester(date)`: è¨ˆç®—æ—¥æœŸå°æ‡‰çš„å­¸æœŸ
- `getSemesterInfo(semester)`: å–å¾—å­¸æœŸè©³ç´°è³‡è¨Š
- `calculateAcademicWeek(date, semester)`: è¨ˆç®—å­¸æœŸé€±æ¬¡
- `getNextMondayISO(date)`: å–å¾—ä¸‹é€±ä¸€æ—¥æœŸ
- `getCurrentSemesterWeek(date)`: å–å¾—å®Œæ•´å­¸æœŸé€±æ¬¡è³‡è¨Š

### æ¸¬è©¦

åŸ·è¡Œå­¸æœŸè¨ˆç®—æ¸¬è©¦ï¼š

```bash
# å®‰è£æ¸¬è©¦ä¾è³´
npm install --save-dev jest @types/jest ts-jest

# åŸ·è¡Œæ¸¬è©¦
npm test semester

# æŸ¥çœ‹æ¸¬è©¦è¦†è“‹ç‡
npm run test:coverage
```

### éŒ¯èª¤è™•ç†

API æœƒå›å‚³æ¨™æº–åŒ–çš„éŒ¯èª¤æ ¼å¼ï¼š

```json
{
  "error": "éŒ¯èª¤è¨Šæ¯",
  "details": "è©³ç´°è³‡è¨Š (å¯é¸)",
  "timestamp": 1726503234567
}
```

### æ—¥èªŒ

æ‰€æœ‰é‡è¦æ“ä½œéƒ½æœƒè¨˜éŒ„æ—¥èªŒï¼š

```bash
[2024-09-16T20:27:14.123Z] [Tschool API] æ”¶åˆ° GET è«‹æ±‚
[2024-09-16T20:27:14.456Z] [Tschool API] å–å¾—ä½¿ç”¨è€…è³‡è¨Š { email: 'test@example.com' }
[2024-09-16T20:27:14.789Z] [Tschool API] æˆåŠŸç”¢ç”Ÿ payload
```

## ğŸš¦ éƒ¨ç½²æª¢æŸ¥æ¸…å–®

- [ ] è¨­å®šæ­£ç¢ºçš„ `TSCHOOL_API_SECRET`
- [ ] ç¢ºèªåŸŸå `cst.zeabur.app` å¯æ­£å¸¸å­˜å–
- [ ] æ¸¬è©¦ API ç«¯é»å›æ‡‰æ­£ç¢º
- [ ] æ›´æ–°æ“´å……åŠŸèƒ½çš„ `API_SECRET`
- [ ] é©—è­‰ CORS è¨­å®šæ­£å¸¸
- [ ] æª¢æŸ¥æ—¥èªŒè¼¸å‡º

## ğŸ”’ å®‰å…¨æ€§

### API å¯†é‘°ç®¡ç†

1. **ç”Ÿæˆå¼·å¯†é‘°**ï¼š
   ```bash
   openssl rand -base64 32
   ```

2. **ç’°å¢ƒè®Šæ•¸è¨­å®š**ï¼š
   - ç”Ÿç”¢ç’°å¢ƒï¼šåœ¨ Zeabur é¢æ¿è¨­å®šç’°å¢ƒè®Šæ•¸
   - é–‹ç™¼ç’°å¢ƒï¼šä½¿ç”¨ `.env.local` (ä¸æäº¤åˆ° Git)

3. **å¯†é‘°è¼ªæ›**ï¼š
   - å®šæœŸæ›´æ›å¯†é‘°
   - åŒæ­¥æ›´æ–° Next.js å’Œæ“´å……åŠŸèƒ½ç«¯

### å®‰å…¨å»ºè­°

- ä½¿ç”¨ HTTPS
- é™åˆ¶ API ä½¿ç”¨é »ç‡
- ç›£æ§ç•°å¸¸è«‹æ±‚
- å®šæœŸæª¢è¦–å­˜å–æ—¥èªŒ

## ğŸ“Š ç›£æ§èˆ‡ç¶­è­·

### æ—¥èªŒç›£æ§

- æª¢è¦– Zeabur æ—¥èªŒ
- ç›£æ§éŒ¯èª¤ç‡
- è¿½è¹¤ API ä½¿ç”¨é‡

### æ•ˆèƒ½å„ªåŒ–

- å¿«å–ç­–ç•¥ (ç›®å‰è¨­ç‚º no-store)
- å£“ç¸®å›æ‡‰
- CDN é…ç½® (å¦‚éœ€è¦)

## ğŸ› å¸¸è¦‹å•é¡Œ

### Q: API å›å‚³ 401 éŒ¯èª¤
A: æª¢æŸ¥ `Authorization` æ¨™é ­å’Œ `TSCHOOL_API_SECRET` æ˜¯å¦ä¸€è‡´

### Q: æ“´å……åŠŸèƒ½ç„¡æ³•å­˜å– API
A: ç¢ºèª `manifest.json` ä¸­æœ‰æ­£ç¢ºçš„ `host_permissions`

### Q: è‡ªè¨‚åœ°é»æ ¼å¼éŒ¯èª¤
A: ç¢ºä¿æ ¼å¼ç‚º `å…¶ä»–åœ°é»:åœ°é»åç¨±`ï¼Œå†’è™Ÿå¾Œä¸èƒ½ç‚ºç©º

### Q: é€±æ¬¡è¨ˆç®—éŒ¯èª¤
A: æ–°ç‰ˆæœ¬ä½¿ç”¨å‹•æ…‹å­¸æœŸè¨ˆç®—ï¼Œæœƒè‡ªå‹•æ ¹æ“šå°ç£å­¸åˆ¶èª¿æ•´ã€‚å¦‚æœ‰å•é¡Œè«‹æª¢æŸ¥ `semester-utils.ts` ä¸­çš„è¨ˆç®—é‚è¼¯

### Q: å­¸æœŸé¡¯ç¤ºä¸æ­£ç¢º
A: ç¢ºèªç³»çµ±æ™‚é–“æ­£ç¢ºï¼ŒAPI æœƒæ ¹æ“šç•¶å‰æ—¥æœŸè‡ªå‹•è¨ˆç®—æ°‘åœ‹å­¸å¹´åº¦å­¸æœŸ

### Q: æ¸¬è©¦å¤±æ•—
A: åŸ·è¡Œ `npm test` æª¢æŸ¥å­¸æœŸè¨ˆç®—é‚è¼¯ï¼Œæ‰€æœ‰æ¸¬è©¦æ¡ˆä¾‹éƒ½æ‡‰è©²é€šé

## ğŸ“ æ”¯æ´

å¦‚æœ‰å•é¡Œï¼Œè«‹æª¢æŸ¥ï¼š

1. ç’°å¢ƒè®Šæ•¸è¨­å®š
2. API å¯†é‘°æ˜¯å¦æ­£ç¢º
3. åŸŸåæ˜¯å¦å¯å­˜å–
4. ç¶²è·¯é€£ç·šç‹€æ³
5. ç€è¦½å™¨æ§åˆ¶å°éŒ¯èª¤è¨Šæ¯

---

**ç‰ˆæœ¬**: 2.0.0 - æ–°å¢å°ç£å­¸åˆ¶å­¸å¹´åº¦å­¸æœŸè¨ˆç®—
**æœ€å¾Œæ›´æ–°**: 2024-09-16

## ğŸ¯ ç‰ˆæœ¬æ›´æ–°è¨˜éŒ„

### v2.0.0 (2024-09-16)
- âœ… æ–°å¢å®Œæ•´çš„å°ç£å­¸åˆ¶æ°‘åœ‹å­¸å¹´åº¦å­¸æœŸè¨ˆç®—ç³»çµ±
- âœ… å¯¦ä½œå‹•æ…‹å­¸æœŸåˆ¤æ–· (YYY-N æ ¼å¼)
- âœ… ç²¾ç¢ºçš„å­¸æœŸé€±æ¬¡è¨ˆç®—é‚è¼¯
- âœ… å®Œæ•´çš„å–®å…ƒæ¸¬è©¦è¦†è“‹ (95%+)
- âœ… å‘å¾Œç›¸å®¹ç¾æœ‰ API åŠŸèƒ½
- âœ… æ–°å¢å‚™ç”¨æ–¹æ¡ˆç¢ºä¿æœå‹™ç©©å®šæ€§

### v1.0.0 (2024-09-15)
- åŸºç¤ API åŠŸèƒ½
- Bearer Token é©—è­‰
- åœ°é»ç®¡ç†èˆ‡è‡ªè¨‚åœ°é»æ”¯æ´
- CORS æ”¯æ´